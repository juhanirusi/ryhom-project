{% extends 'boilerplate.html' %}

{% block title %}{{ micropost.title }} - {{ request.META.HTTP_HOST }}{% endblock title %}
{% block meta_description %}{{ micropost.title | slice:':160' }}{% endblock meta_description %}
{% block meta_author %}{{ micropost.author }}{% endblock meta_author %}

{% block content %}

  {% if micropost.author.profile_image.url != '' %}
    <img src="{{ micropost.author.profile_image.url }}" alt="{{ micropost.author.name }}'s profile image" width="100" height="100"></img>
  {% endif %}

  <a href="{{ micropost.author.get_absolute_url }}">{{ micropost.author }}</a>
  {{ micropost.modified | date:'M j, Y' }}

  <h1>{{ micropost.title }}</h1>

  {% if micropost.image.url != '' %}
    <picture>
      <img src="{{ micropost.image.url }}" alt="Featured image for article, {{ micropost.title }}"></img>
    </picture>
  {% endif %}

  <article>
    {{ micropost.content | safe }}
  </article>

  <p>Tags:
  {% for tag in micropost.tags.all %}
    <a href="{{ tag.get_absolute_url }}">{{ tag.name }}</a>
  {% endfor %}
  </p>

  {% if user.is_authenticated %}
    <h2>{{ nro_of_comments }} {% if nro_of_comments == 1 %}comment{% else %}comments{% endif %}</h2>
    <form action="" method="POST">
      {% csrf_token %}
      <label for="comment">Type Comment here</label>
      {{ comment_form.comment }}
      <input type="submit" value="Post">
    </form>
  {% else %}
    <h2>{{ nro_of_comments }} {% if nro_of_comments == 1 %}comment{% else %}comments{% endif %} - You need to <a href="{% url 'accounts:login' %}?next={{ request.path }}">Login</a> to comment</h2>
  {% endif %}

  {% for comment in comments %}
    {% if comment.is_parent %}
    <p>{{ comment.created | timesince }}</p>
    <h3>{{ comment.author }} : {{ comment.comment }}</h3>
    <p>{{ comment.upvotes }}</p>

    {% for replies in comment.child_comments %}
      <p>--{{ comment.created | timesince }}</p>
      <h3>--{{ comment.author }} : {{ replies.comment }}</h3>
      <p>--{{ comment.upvotes }}</p>
    {% endfor %}

    {% if user.is_authenticated %}
      <form action="" method="POST">
        {% csrf_token %}
        <label for="comment">Reply here</label>
        <textarea type="text" name="comment" maxlength="6000"></textarea>
        <input type="hidden" value="{{ comment.pk }}" name="parent">
        <input type="submit" value="Post">
      </form>
    {% endif %}
    {% endif %}
  {% endfor %}

{% endblock content %}